<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>SQL语法 &mdash; 个人博客</title><link rel="stylesheet" href="https://bigbigda.github.io/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://bigbigda.github.io/assets/css/components/collection.css"><link rel="stylesheet" href="https://bigbigda.github.io/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://bigbigda.github.io/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://bigbigda.github.io/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://bigbigda.github.io/assets/css/globals/common.css"><link rel="stylesheet" href="https://bigbigda.github.io/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://bigbigda.github.io/assets/css/posts/index.css"><link rel="stylesheet" href="https://bigbigda.github.io/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"><link rel="canonical" href="https://bigbigda.github.io/2023/11/21/SQL/"><link rel="alternate" type="application/atom+xml" title="个人博客" href="https://bigbigda.github.io/feed.xml"><link rel="shortcut icon" href="https://bigbigda.github.io/favicon.ico"><meta property="og:title" content="SQL语法"><meta name="keywords" content="SQL,Presto,Hive,Snip"><meta name="og:keywords" content="SQL,Presto,Hive,Snip"><meta name="description" content="[TOC]"><meta name="og:description" content="[TOC]"><meta property="og:url" content="https://bigbigda.github.io/2023/11/21/SQL/"><meta property="og:site_name" content="个人博客"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2023-11-21"> <script src="https://bigbigda.github.io/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://bigbigda.github.io/assets/js/jquery-ui.js"></script> <script src="https://bigbigda.github.io/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80669434-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-80669434-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://bigbigda.github.io/" title="个人博客"><span class="octicon octicon-mark-github"></span> 个人博客</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://bigbigda.github.io/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://bigbigda.github.io/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://bigbigda.github.io/links/" class=" site-header-nav-item" target="" title="链接">链接</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="SQL语法"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">SQL语法</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2023/11/21 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://bigbigda.github.io/categories/#snip" title="snip">snip</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 5012 字，约 15 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>[TOC]</p><h3 id="正则表达式">正则表达式</h3><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- regex_extract 第二个参数为正则表达式，第三个参数表示位置，为0时返回参数二正则表达式匹配到的字符串，为其他正整数时为该正则表达式第N个括号内的内容，如果未匹配成功，返回空字符串（与第三个参数取值无关）</span>

<span class="k">SELECT</span> <span class="n">ab_trace_tag</span><span class="p">,</span>
       <span class="n">regexp_extract</span><span class="p">(</span><span class="n">ab_trace_tag</span><span class="p">,</span><span class="s1">'.*(22-86:)'</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
       <span class="n">regexp_extract</span><span class="p">(</span><span class="n">ab_trace_tag</span><span class="p">,</span><span class="s1">'.*(22-86:)'</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
       <span class="n">regexp_extract</span><span class="p">(</span><span class="n">ab_trace_tag</span><span class="p">,</span><span class="s1">'(22-108:).*(?=,)'</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>  <span class="c1">-- 贪婪匹配       </span>
       <span class="n">regexp_extract</span><span class="p">(</span><span class="n">ab_trace_tag</span><span class="p">,</span><span class="s1">'(22-108:).*?(?=,)'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">-- 非贪婪匹配</span>
  <span class="k">FROM</span> <span class="n">db</span><span class="p">.</span><span class="n">hive_table_name</span>
 <span class="k">where</span> <span class="n">dt</span> <span class="o">=</span> <span class="s1">'20200115'</span>
   <span class="k">and</span> <span class="n">slot_id</span> <span class="o">=</span> <span class="mi">10002</span>
 <span class="k">limit</span> <span class="mi">100</span>
</code></pre></div></div><p>其他例子</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">regexp_extract</span><span class="p">(</span><span class="n">ab_trace_tag</span><span class="p">,</span><span class="s1">'(21-109:)(</span><span class="se">\d</span><span class="s1">{3}$|.*?(?=,))'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
<span class="n">String</span> <span class="n">pattern</span> <span class="o">=</span> <span class="nv">"(?&lt;=delocText</span><span class="se">\"</span><span class="nv">:</span><span class="se">\"</span><span class="nv">)(.*?)(?=</span><span class="se">\"</span><span class="nv">)"</span> 
</code></pre></div></div><h4 id="hive">Hive</h4><p>Hive中使用正则表达式的三种方式</p><ul><li>rlike 用于where语句中进行筛选</li><li>regexp_extract 用于提取匹配的字符串</li><li>regexp_replace 用于替换<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-- hive
select slot_id, request_id, source, content, id from db.hive_table_name
       WHERE dt='20200117' and id rlike 'test.*'
</code></pre></div></div><h4 id="presto">Presto</h4></li><li>regexp_extract<ul><li>支持regexp_extract(string, pattern), 相比之下，hive不支持此语法，如果没有第三个参数，hive默认添加参数1，如果没有分组，则报错</li></ul></li><li>regexp_extract_all<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select slot_id, request_id, source, content, id from db.hive_table_name
       WHERE dt='20200117' and regexp_like(id,'test')    
</code></pre></div></div></li></ul><h3 id="json处理及字符串拆分">json处理及字符串拆分</h3><h4 id="presto-1">presto</h4><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">tmp</span><span class="p">.</span><span class="n">expanded_recall_0115</span> <span class="k">as</span> <span class="k">SELECT</span> <span class="n">request_id</span><span class="p">,</span>
       <span class="n">shop_id</span><span class="p">,</span>
       <span class="n">launch_id</span><span class="p">,</span>
       <span class="n">json_extract</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="n">extensions</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">),</span><span class="s1">'$.xgs.defineTalkSwitch'</span><span class="p">)</span> <span class="k">as</span> <span class="n">defineTalk</span><span class="p">,</span>
       <span class="n">json_extract</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="n">extensions</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">),</span><span class="s1">'$.xgs.smartTalkSwitch'</span><span class="p">)</span> <span class="k">as</span> <span class="n">samrtTalk</span><span class="p">,</span>
       <span class="n">json_extract</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="n">extensions</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">),</span><span class="s1">'$.xgs.xgsMaterial.source'</span><span class="p">)</span><span class="k">as</span> <span class="k">source</span><span class="p">,</span>
       <span class="n">json_extract</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="n">extensions</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">),</span><span class="s1">'$.xgs.xgsMaterial.id'</span><span class="p">)</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span>
       <span class="n">json_extract</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="n">extensions</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">),</span><span class="s1">'$.xgs.xgsMaterial.content'</span><span class="p">)</span><span class="k">as</span> <span class="n">content</span><span class="p">,</span>
       <span class="n">url</span>
  <span class="k">from</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">request_id</span><span class="p">,</span>
               <span class="n">json_extract</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="s1">'{'</span><span class="p">,</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">tmp_col</span><span class="p">,</span><span class="s1">'</span><span class="se">\[\{</span><span class="s1">'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">'}'</span><span class="p">),</span><span class="s1">'$.dp_shop_id'</span><span class="p">)</span> <span class="n">shop_id</span><span class="p">,</span>
               <span class="n">json_extract</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="s1">'{'</span><span class="p">,</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">tmp_col</span><span class="p">,</span><span class="s1">'</span><span class="se">\[\{</span><span class="s1">'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">'}'</span><span class="p">),</span><span class="s1">'$.launch_id'</span><span class="p">)</span> <span class="n">launch_id</span><span class="p">,</span>
               <span class="n">json_extract</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="s1">'{'</span><span class="p">,</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">tmp_col</span><span class="p">,</span><span class="s1">'</span><span class="se">\[\{</span><span class="s1">'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">'}'</span><span class="p">),</span><span class="s1">'$.image_urls'</span><span class="p">)</span> <span class="n">url</span><span class="p">,</span>
               <span class="n">json_extract</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="s1">'{'</span><span class="p">,</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">tmp_col</span><span class="p">,</span><span class="s1">'</span><span class="se">\[\{</span><span class="s1">'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">'}'</span><span class="p">),</span><span class="s1">'$.extensions'</span><span class="p">)</span> <span class="n">extensions</span>
          <span class="k">FROM</span> <span class="n">db</span><span class="p">.</span><span class="n">hive_table_name</span>
         <span class="k">CROSS</span> <span class="k">JOIN</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">ads</span><span class="p">,</span> <span class="s1">'},{'</span><span class="p">))</span> <span class="k">as</span> <span class="n">tb</span> <span class="p">(</span><span class="n">tmp_col</span><span class="p">)</span>
         <span class="k">WHERE</span> <span class="n">dt</span> <span class="o">=</span> <span class="s1">'20200112'</span>
           <span class="k">and</span> <span class="n">slot_id</span> <span class="k">in</span> <span class="p">(</span><span class="mi">10002</span><span class="p">)</span>
       <span class="p">)</span>


<span class="c1">-- 同时存在array和json解析</span>
<span class="k">select</span> <span class="n">json_extract</span><span class="p">(</span><span class="n">json_array_get</span><span class="p">(</span><span class="n">json_extract</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="s1">'$.richtextlist'</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span><span class="s1">'$.text'</span><span class="p">)</span>
</code></pre></div></div><h4 id="hive-1">hive</h4><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">request_id</span><span class="p">,</span>
       <span class="n">shop_id</span><span class="p">,</span>
       <span class="n">launch_id</span><span class="p">,</span>
       <span class="n">get_json_object</span><span class="p">(</span><span class="n">extensions</span><span class="p">,</span><span class="s1">'$.zgs.defineTalkSwitch'</span><span class="p">)</span> <span class="k">as</span> <span class="n">defineTalkSwitch</span><span class="p">,</span>
       <span class="n">get_json_object</span><span class="p">(</span><span class="n">extensions</span><span class="p">,</span><span class="s1">'$.zgs.smartTalkSwitch'</span><span class="p">)</span> <span class="k">as</span> <span class="n">smartTalkSwitch</span><span class="p">,</span>
       <span class="n">get_json_object</span><span class="p">(</span><span class="n">extensions</span><span class="p">,</span><span class="s1">'$.zgs.zgsMaterial.source'</span><span class="p">)</span> <span class="k">as</span> <span class="k">source</span><span class="p">,</span>
       <span class="n">get_json_object</span><span class="p">(</span><span class="n">extensions</span><span class="p">,</span><span class="s1">'$.zgs.zgsMaterial.id'</span><span class="p">)</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span>
       <span class="n">get_json_object</span><span class="p">(</span><span class="n">extensions</span><span class="p">,</span><span class="s1">'$.zgs.zgsMaterial.content'</span><span class="p">)</span> <span class="k">as</span> <span class="n">content</span><span class="p">,</span>
       <span class="n">url</span><span class="p">,</span>
       <span class="n">dt</span><span class="p">,</span>
       <span class="n">hour</span>
  <span class="k">from</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">request_id</span><span class="p">,</span>
               <span class="n">tmp_col</span><span class="p">,</span>
               <span class="n">get_json_object</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="s1">'{'</span><span class="p">,</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">tmp_col</span><span class="p">,</span><span class="s1">'</span><span class="se">\\</span><span class="s1">[</span><span class="se">\\</span><span class="s1">{'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">'}'</span><span class="p">),</span><span class="s1">'$.dp_shop_id'</span><span class="p">)</span> <span class="n">shop_id</span><span class="p">,</span>
               <span class="n">get_json_object</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="s1">'{'</span><span class="p">,</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">tmp_col</span><span class="p">,</span><span class="s1">'</span><span class="se">\\</span><span class="s1">[</span><span class="se">\\</span><span class="s1">{'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">'}'</span><span class="p">),</span><span class="s1">'$.launch_id'</span><span class="p">)</span> <span class="n">launch_id</span><span class="p">,</span>
               <span class="n">get_json_object</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="s1">'{'</span><span class="p">,</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">tmp_col</span><span class="p">,</span><span class="s1">'</span><span class="se">\\</span><span class="s1">[</span><span class="se">\\</span><span class="s1">{'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">'}'</span><span class="p">),</span><span class="s1">'$.image_urls'</span><span class="p">)</span> <span class="n">url</span><span class="p">,</span>
               <span class="n">get_json_object</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="s1">'{'</span><span class="p">,</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">tmp_col</span><span class="p">,</span><span class="s1">'</span><span class="se">\\</span><span class="s1">[</span><span class="se">\\</span><span class="s1">{'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">'}'</span><span class="p">),</span><span class="s1">'$.extensions'</span><span class="p">)</span> <span class="n">extensions</span><span class="p">,</span>
               <span class="n">dt</span><span class="p">,</span>
               <span class="n">hour</span>
          <span class="k">FROM</span> <span class="n">db</span><span class="p">.</span><span class="n">hive_table_name</span> <span class="k">lateral</span> <span class="k">view</span> <span class="n">explode</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">ads</span><span class="p">,</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">},</span><span class="se">\\</span><span class="s1">{'</span><span class="p">))</span> <span class="n">tb</span> <span class="k">as</span> <span class="n">tmp_col</span>
         <span class="k">WHERE</span> <span class="n">dt</span> <span class="o">=</span> <span class="s1">'$now.datekey'</span>
           <span class="k">and</span> <span class="n">slot_id</span> <span class="k">in</span> <span class="p">(</span><span class="mi">10002</span><span class="p">,</span><span class="mi">10011</span><span class="p">)</span>
       <span class="p">)</span> <span class="k">c</span>
     
</code></pre></div></div><h3 id="时间转换">时间转换</h3><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Hive</span>
<span class="k">select</span> <span class="n">unix_timestamp</span><span class="p">(</span><span class="s1">'20190909'</span><span class="p">,</span><span class="s1">'yyyyMMdd'</span><span class="p">)</span>  <span class="k">from</span> <span class="n">db</span><span class="p">.</span><span class="n">hive_table_name</span>

<span class="n">from_unixtime</span><span class="p">(</span><span class="n">unix_timestamp</span><span class="p">(</span><span class="s1">'20190909'</span><span class="p">,</span><span class="s1">'yyyyMMdd'</span><span class="p">),</span><span class="s1">'yyyy-MM-dd'</span><span class="p">)</span>
<span class="n">from_unixtime</span><span class="p">(</span><span class="n">unix_timestamp</span><span class="p">(</span><span class="n">hp_stat_date</span><span class="p">,</span><span class="s1">'yyyy-mm-dd'</span><span class="p">),</span><span class="s1">'yyyymmdd'</span><span class="p">)</span>
<span class="n">date_format</span><span class="p">(</span><span class="n">date_parse</span><span class="p">(</span><span class="s1">'20190805'</span><span class="p">,</span><span class="s1">'%Y%m%d'</span><span class="p">),</span><span class="s1">'%Y-%m-%d'</span><span class="p">)</span> 
<span class="n">datediff</span><span class="p">(</span><span class="s1">'2020-05-14'</span><span class="p">,</span><span class="n">date_format</span><span class="p">(</span><span class="k">cast</span> <span class="p">(</span><span class="s1">'2020-05-01 11:48:15'</span> <span class="k">as</span> <span class="nb">timestamp</span><span class="p">)</span> <span class="p">,</span><span class="s1">'yyyy-MM-dd'</span><span class="p">))</span>

<span class="c1">-- Presto</span>
<span class="n">format_datetime</span><span class="p">(</span><span class="n">date_parse</span><span class="p">(</span><span class="s1">'2020-03-02'</span><span class="p">,</span><span class="s1">'%Y-%m-%d'</span><span class="p">)</span> <span class="p">,</span><span class="s1">'yyyyMMdd'</span><span class="p">)</span>
<span class="n">datediff</span><span class="p">(</span><span class="s1">'2020-05-14'</span><span class="p">,</span><span class="n">format_datetime</span><span class="p">(</span><span class="k">cast</span> <span class="p">(</span><span class="n">createtime</span> <span class="k">as</span> <span class="nb">timestamp</span><span class="p">)</span> <span class="p">,</span><span class="s1">'yyyy-MM-dd'</span><span class="p">))</span>
<span class="n">date_format</span><span class="p">(</span><span class="n">date_parse</span><span class="p">(</span><span class="s1">'20200302'</span><span class="p">,</span><span class="s1">'%Y%m%d'</span><span class="p">)</span><span class="o">+</span> <span class="n">interval</span> <span class="s1">'-1'</span> <span class="k">day</span><span class="p">,</span><span class="s1">'%Y%m%d'</span><span class="p">)</span>
 
</code></pre></div></div><h3 id="字符串分割拼接">字符串分割&amp;拼接</h3><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Hive</span>
<span class="k">select</span> <span class="n">mt_poi_id</span><span class="p">,</span> 
    <span class="n">dp_shop_id</span><span class="p">,</span>
    <span class="n">mt_poi_first_cate_id</span><span class="p">,</span>
    <span class="n">tag</span>
<span class="k">from</span> <span class="n">db</span><span class="p">.</span><span class="n">hive_table_name</span>
<span class="k">lateral</span> <span class="k">view</span> <span class="n">explode</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="s1">'刂'</span><span class="p">))</span> <span class="n">myTable</span> <span class="k">as</span> <span class="n">tag</span>

<span class="c1">-- Presto</span>
<span class="k">SELECT</span> <span class="n">student</span><span class="p">,</span>
       <span class="n">score</span>
  <span class="k">FROM</span> <span class="n">tests</span>
 <span class="k">CROSS</span> <span class="k">JOIN</span> <span class="k">UNNEST</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="k">AS</span> <span class="n">t</span> <span class="p">(</span><span class="n">score</span><span class="p">)</span>
 
<span class="k">select</span> <span class="n">mt_poi_id</span><span class="p">,</span>
       <span class="n">dp_shop_id</span><span class="p">,</span>
       <span class="n">mt_poi_first_cate_id</span><span class="p">,</span>
       <span class="n">array_join</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="n">tags</span><span class="p">),</span> <span class="s1">'刂'</span><span class="p">)</span>
  <span class="k">from</span> <span class="n">db</span><span class="p">.</span><span class="n">hive_table_name</span>
 <span class="k">group</span> <span class="k">by</span> <span class="n">mt_poi_id</span><span class="p">,</span>
          <span class="n">dp_shop_id</span><span class="p">,</span>
          <span class="n">mt_poi_first_cate_id</span> 
</code></pre></div></div><h3 id="snippets">snippets</h3><h4 id="case语句">case语句</h4><pre><code class="language-SQL">SELECT CASE WHEN (exp like '%2-194:1420%') THEN 'lr_color1'
            WHEN (exp like '%2-194:1701%') THEN 'lr_color2'
            WHEN (exp like '%2-226:2139%') THEN 'food_color1'
            WHEN (exp like '%2-256:2140%') THEN 'xiuyu_color1'
            WHEN (exp like '%2-271:2141%') THEN 'yiliao_color1'
            ELSE 'others'
             END as expid
  FROM db.hive_table_name
 where dt = '20210316'
   and id is not null
   and id != ''
   and pos = 1

</code></pre><h4 id="时间">时间</h4><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'${now.datekey}'
'${now.date}'
'${now.delta(days=365).date}'
</code></pre></div></div><h4 id="百分比">百分比</h4><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>approx_percentile(dealidcnt,array[0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.99,1])
</code></pre></div></div><h4 id="转义字符">转义字符</h4><p>prosto中转义字符用\, hive中转义字符需要用\\</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- presto</span>
<span class="k">select</span> <span class="n">shopid</span><span class="p">,</span><span class="n">mark_number_feature</span><span class="p">,</span><span class="n">mark_number</span><span class="p">,</span><span class="n">rn</span> <span class="k">from</span> <span class="p">(</span>
<span class="k">SELECT</span> <span class="n">shopid</span><span class="p">,</span>
       <span class="n">regexp_extract</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="s1">'(wish</span><span class="se">\^</span><span class="s1">).*?(?=</span><span class="se">\^</span><span class="s1">)'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">mark_number_feature</span><span class="p">,</span>
       <span class="n">regexp_extract</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="s1">'(?&lt;=wish</span><span class="se">\^</span><span class="s1">).*?(?=</span><span class="se">\^</span><span class="s1">)'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">mark_number</span><span class="p">,</span>
       <span class="n">row_number</span><span class="p">()</span> <span class="n">over</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">shopid</span> <span class="k">order</span> <span class="k">by</span> <span class="n">partition_date</span><span class="p">,</span><span class="n">reqid</span> <span class="k">desc</span><span class="p">)</span> <span class="n">rn</span>
  <span class="k">FROM</span> <span class="n">db</span><span class="p">.</span><span class="n">hive_table_name</span>
 <span class="k">where</span> <span class="n">partition_date</span> <span class="o">=</span> <span class="s1">'2020-04-01'</span>
   <span class="k">and</span> <span class="n">slot_id</span> <span class="o">=</span> <span class="mi">10010</span>
<span class="p">)</span><span class="n">t1</span> <span class="k">where</span> <span class="n">rn</span> <span class="o">=</span> <span class="mi">1</span>


<span class="c1">-- hive</span>
<span class="k">SELECT</span> <span class="n">shopid</span><span class="p">,</span>
       <span class="n">regexp_extract</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="s1">'(wish</span><span class="se">\\</span><span class="s1">^).*?(?=</span><span class="se">\\</span><span class="s1">^)'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">mark_number_feature</span><span class="p">,</span>
       <span class="n">regexp_extract</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="s1">'(?&lt;=wish</span><span class="se">\\</span><span class="s1">^).*?(?=</span><span class="se">\\</span><span class="s1">^)'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">mark_number</span><span class="p">,</span>
       <span class="n">row_number</span><span class="p">()</span> <span class="n">over</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">shopid</span> <span class="k">order</span> <span class="k">by</span> <span class="n">partition_date</span><span class="p">,</span><span class="n">reqid</span> <span class="k">desc</span><span class="p">)</span> <span class="n">rn</span>
  <span class="k">FROM</span> <span class="n">db</span><span class="p">.</span><span class="n">hive_table_name</span>
 <span class="k">where</span> <span class="n">partition_date</span> <span class="o">=</span> <span class="s1">'2020-04-01'</span> <span class="k">and</span> <span class="n">slot_id</span> <span class="o">=</span> <span class="mi">10010</span>
</code></pre></div></div><h3 id="参考资料">参考资料</h3><ul><li>presto和hive解析json<ul><li>https://www.cnblogs.com/drjava/p/10536922.html</li></ul></li></ul><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://bigbigda.github.io" target="_blank">nice</a></li><li>本文链接：<a href="https://bigbigda.github.io/2023/11/21/SQL/" target="_blank">https://bigbigda.github.io/2023/11/21/SQL/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://bigbigda.github.io/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://bigbigda.github.io/assets/search_data.json?v=1700647925', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://bigbigda.github.io/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2022 <span title="nice">nice</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/bigbigda/bigbigda.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://bigbigda.github.io/" title="首页" target="">首页</a></li><li> <a href="https://bigbigda.github.io/categories/" title="分类" target="">分类</a></li><li> <a href="https://bigbigda.github.io/links/" title="链接" target="">链接</a></li><li><a href="https://bigbigda.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://bigbigda.github.io/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
